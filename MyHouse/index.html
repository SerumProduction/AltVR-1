<!DOCTYPE html>
<html>
<head>
  <title>House</title>
  <script src="https://aframe.io/releases/0.3.0/aframe.js"></script>
  <script src='https://sdk.altvr.com/libs/altspace.js/2.6.1/altspace.min.js'></script>
</head>
<body>
	<a-scene altspace='fullspace: true' sync-system='author: BenG; app: Home; instance: home; refUrl: https://altvr-apps.firebaseio.com/'>
		<a-mixin id='color1' material='color: #800'></a-mixin>
		<a-mixin id='walls' material='color: #410' n-box-collider='type: environment'></a-mixin>

		<a-entity scale='1.2 1.2 1.2' position='0 0 0'>
			<a-box id='noEntry' position='0 1.5 -10' scale='5.9 2.9 4.9' opacity='0' altspace-cursor-collider='enabled: false'></a-box>
			<a-entity id='door' position='-2 1 -7.55'>
				<a-box position='0.5 0 0' scale='1 2 .1' color='#007' n-box-collider='type: environment'></a-box>
				<a-animation to='0 90 0' dur='3000' begin='open'></a-animation>
				<a-animation to='0 0 0' dur='3000' begin='close'></a-animation>
			</a-entity>
			<a-box id='keySpawn' position='-1.5 -100 -6.5' scale='2 2 2' opacity='0' altspace-cursor-collider='enabled: false'></a-box>
			<!-- <a-box id='entry' position='-1.5 -1 -7.55' scale='1 2 .1' color='#0f0' opacity='0' altspace-cursor-collider='enabled: false'></a-box> -->

			<a-box id='window' position='1 1.5 -7.55' scale='1.5 1 .1' color='#fff' opacity='0.01' n-box-collider='type: environment'></a-box>


			<!-- front wall -->
			<a-box position='-2.5 1.5 -7.55' scale='1 3 .1' mixin='walls'></a-box>
			<a-box position='-1.5 2.5 -7.55' scale='1 1 .1' mixin='walls'></a-box>
			<a-box position='-.375 1.5 -7.55' scale='1.25 3 .1' mixin='walls'></a-box>
			<a-box position='2.375 1.5 -7.55' scale='1.25 3 .1' mixin='walls'></a-box>
			<a-box position='1 2.5 -7.55' scale='1.5 1 .1' mixin='walls'></a-box>
			<a-box position='1 0.5 -7.55' scale='1.5 1 .1' mixin='walls'></a-box>

			<a-box position='0 1.5 -12.45' scale='6 3 .1' mixin='walls'></a-box>
			<a-box position='2.95 1.5 -10' scale='.1 3 5' mixin='walls'></a-box>
			<a-box position='-2.95 1.5 -10' scale='.1 3 5' mixin='walls'></a-box>
			<a-box position='0 2.95 -10' scale='6 .1 5' mixin='walls'></a-box>


			<a-entity id='target' position='0 0 0' rotation='0 180 0'></a-entity>
			<a-entity id='portal1' position='0 -100 0' n-portal='targetEntity: #target' n-skeleton-parent='part: head'></a-entity>


			<!-- <a-box id='btn1' position='-.8 1.3 -7.55' scale='.08 .08 .15' color='green'></a-box> -->
			<a-box id='btn1' position='-.8 1.3 -7.6125' scale='.08 .08 .025' color='green' n-box-collider='type: hologram'></a-box>
			<a-box id='btn2' position='-.8 1.3 -7.4875' scale='.07 .07 .025' color='red' n-box-collider='type: hologram'>
				<a-entity id='bell' sync sync-n-sound></a-entity>
			</a-box>

			<a-entity position='-4 0 -5'>
				<a-box position='0 .625 0' scale='.05 1.25 .05' color='#000'></a-box>
				<a-box position='0 1.5 0' scale='.8 .5 .05' color='#000'></a-box>
				<a-entity position='0 1.5 0.027' scale='.6 .6 .6' n-text='text: Under\nConstruction; fontSize: 2'></a-entity>
			</a-entity>

			<!-- key -->

				<a-mixin id='key1' position='-.07 -.025 -.07' scale='.003 .08 .003' rotation='0 0 90' geometry='primitive: cylinder; segments-height: 1; segments-radial: 10' n-skeleton-parent='part:hand; side: right' sync sync-n-skeleton-parent></a-mixin>
				<a-mixin id='key2' position='-.02 -.025 -.07' rotation='90 0 0' geometry='primitive: torus; radius: .01; radius-tubular: .0015; segments-radial: 6; segments-tubular: 16' n-skeleton-parent='part:hand; side: right' sync sync-n-skeleton-parent></a-mixin>
				<a-mixin id='key3' position='-.105 -.025 -.078' scale='.004 .002 .013' geometry='primitive: box' n-skeleton-parent='part:hand; side: right' sync sync-n-skeleton-parent></a-mixin>
				<a-mixin id='key4' position='-.1 -.025 -.075' scale='.004 .002 .01' geometry='primitive: box' n-skeleton-parent='part:hand; side: right' sync sync-n-skeleton-parent></a-mixin>
				<a-mixin id='key5' position='-.095 -.025 -.078' scale='.004 .002 .013' geometry='primitive: box' n-skeleton-parent='part:hand; side: right' sync sync-n-skeleton-parent></a-mixin>

				<a-mixin id='gold' material='color: #786c14'></a-mixin>
				<a-mixon id='synced' sync sync-n-skeleton-parent></a-mixon>

				<!-- <a-entity mixin='key1 gold'></a-entity>
				<a-entity mixin='key2 gold'></a-entity>
				<a-entity mixin='key3 gold'></a-entity>
				<a-entity mixin='key4 gold'></a-entity>
				<a-entity mixin='key5 gold'></a-entity> -->

			<!-- <a-entity position='0 1.5 0' rotation='-90 0 0'>
				<a-cylinder position='-.07 -.025 -.07' scale='.003 .08 .003' rotation='0 0 90' color='#786c14'></a-cylinder>
				<a-torus position='-.02 -.025 -.07' rotation='90 0 0' radius='.01' radius-tubular='.0015' color='#786c14'></a-torus>
				<a-box position='-.105 -.025 -.078' scale='.004 .002 .013' color='#786c14'></a-box>
				<a-box position='-.1 -.025 -.075' scale='.004 .002 .01' color='#786c14'></a-box>
				<a-box position='-.095 -.025 -.078' scale='.004 .002 .013' color='#786c14'></a-box>
			</a-entity> -->
		</a-entity>
		<a-entity position='0 0 -60' rotation='0 180 0'>
			<a-entity position='0 0 0' n-object='res: objects/bunny-ball-white'></a-entity>
			<a-entity position='0.5 0 0' n-object='res: objects/kitten-grey'></a-entity>
			<a-entity position='1 0 0' n-object='res: objects/kitten-yellow'></a-entity>
			<a-entity position='1.5 0 0' n-object='res: objects/red-panda'></a-entity>
			<a-entity position='2 0 0' n-object='res: objects/corgi-red'></a-entity>
			<a-entity position='2.5 0 0' n-object='res: objects/corgi-grey'></a-entity>
			<a-entity position='3 0 0' n-object='res: objects/kiwi'></a-entity>
			<a-entity position='3.5 0 0' n-object='res: objects/owl'></a-entity>
			<a-entity position='4 0 0' n-object='res: objects/bear-standing'></a-entity>
			<a-entity position='4.5 0 0' n-object='res: objects/cat-standing'></a-entity>
			<a-entity position='5 0 0' n-object='res: objects/panda-standing'></a-entity>
			<a-entity position='5.5 0 0' n-object='res: objects/fox-standing'></a-entity>
			<a-entity position='6 0 0' n-object='res: objects/rabbit-standing'></a-entity>
			<a-entity position='6.5 0 0' n-object='res: objects/dog-standing'></a-entity>
			<a-entity position='7 0 0' n-object='res: objects/penguin-standing'></a-entity>

			<a-entity position='0 1 2' n-spawner='res: interactables/roasting-stick'></a-entity>
			<a-entity position='0.5 1 2' n-spawner='res: interactables/roman-candle-1'></a-entity>
			<a-entity position='1.5 1 2' n-object='res: objects/marshmallow-bag'></a-entity>
			<a-entity position='2 1 2' n-object='res: objects/heatsource-campfire'></a-entity>
			<a-entity position='3 1 2' n-object='res: objects/marimba'></a-entity>

			<a-entity position='0 0 3' n-object='res: objects/bbq-cart'></a-entity>
			<a-entity position='0.5 0 3' n-object='res: objects/burgers-uncooked'></a-entity>
			<a-entity position='1 1 3' n-object='res: objects/pizza-box'></a-entity>
			<a-entity position='2 0 3' n-object='res: objects/charcoal-grill'></a-entity>
			<a-entity position='3 1 3' n-spawner='res: interactables/burger-patty'></a-entity>
			<a-entity position='3.5 1 3' n-spawner='res: interactables/burger-sandwich'></a-entity>
			<a-entity position='4 1 3' n-spawner='res: interactables/can-beer-king'></a-entity>
			<a-entity position='4.5 1 3' n-spawner='res: interactables/can-beer-litaf'></a-entity>
			<a-entity position='5 1 3' n-spawner='res: interactables/can-beer-millenniale'></a-entity>
			<a-entity position='5.5 1 3' n-spawner='res: interactables/can-beer-oface'></a-entity>
			<a-entity position='6 1 3' n-spawner='res: interactables/can-beer-pegleg'></a-entity>
			<a-entity position='6.5 1 3' n-spawner='res: interactables/can-soda-coconut'></a-entity>
			<a-entity position='7 1 3' n-spawner='res: interactables/can-soda-melon'></a-entity>
			<a-entity position='7.5 1 3' n-spawner='res: interactables/pizza-slice'></a-entity>
			<a-entity position='8 1 3' n-spawner='res: interactables/spatula'></a-entity>

			<a-entity position='0 1 4' n-spawner='res: interactables/glowstick-green'></a-entity>
			<a-entity position='0.5 1 4' n-spawner='res: interactables/glowstick-purple'></a-entity>
			<a-entity position='1 1 4' n-spawner='res: interactables/glowstick-red'></a-entity>
			<a-entity position='1.5 1 4' n-spawner='res: interactables/glowstick-orange'></a-entity>
			<a-entity position='2 1 4' n-spawner='res: interactables/glowstick-blue'></a-entity>
			<a-entity position='2.5 1 4' n-spawner='res: interactables/glowstick-magenta'></a-entity>
			<a-entity position='3 1 4' n-spawner='res: interactables/pingpong-ball'></a-entity>
			<a-entity position='3.5 1 4' n-spawner='res: interactables/red-cup'></a-entity>
			<a-entity position='4 0 4' n-object='res: objects/red-cup-stack'></a-entity>
			<a-entity position='4.5 0 4' n-object='res: objects/stand-glowstick'></a-entity>
		</a-entity>

		<a-mixin id='bunnyHat' position='0 0.11 0.04' scale='1.3 1.3 1.3' n-object='res: objects/bunny-ball-white' n-skeleton-parent='part: head' sync sync-n-skeleton-parent></a-mixin>

		<a-mixin id='chickenThing' position='0.19 0.47 0' n-object='res: objects/kiwi' n-skeleton-parent='part: spine' sync sync-n-skeleton-parent></a-mixin>

		<!-- <a-entity one-per-user='mixin: bunnyHat'></a-entity> -->
		
	</a-scene>
<script>
	bell.setAttribute('n-sound', {src: /Mobile/i.test(navigator.userAgent) ? 'dingdong.mp3' : 'dingdong.ogg', volume: .25, spatialBlend: 1});
	var scene = document.querySelector('a-scene');
	var sync;
	scene.addEventListener('connected', function() {
		sync = scene.systems['sync-system'].connection;
		


		var granted = false;
		noEntry.object3D.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({ jointCubeSize: 0.01, joints: [['Head', 'Center', 0]]}));
		noEntry.object3D.addEventListener('jointcollisionenter', function(){
			if (doorState == 'closed') {
				console.log('nope');
				portal1.setAttribute('position', '0 0 0');
		    setTimeout(function(){
		      portal1.setAttribute('position', '0 -100 0');
		    }, 1000);
		  } else {
		  	console.log('access granted');
				granted = true;
				noEntry.setAttribute('position', '0 -1000 0');
		  }
		});

		var doorState = 'closed'
		altspace.getUser().then(function(user){
			if (user.userId == '582115151281389721') {
				granted = true;
				noEntry.setAttribute('position', '0 -1000 0');
				keySpawn.setAttribute('position', '-1.5 1 -6.5');

				var hasKey = false;
				keySpawn.object3D.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({ jointCubeSize: 0.01, joints: [['Head', 'Center', 0]]}));
				keySpawn.object3D.addEventListener('jointcollisionenter', function(){
					hasKey = true;
					scene.systems['sync-system'].instantiate('key1 gold', scene, scene, 'keyPart1');
					scene.systems['sync-system'].instantiate('key2 gold', scene, scene, 'keyPart2');
					scene.systems['sync-system'].instantiate('key3 gold', scene, scene, 'keyPart3');
					scene.systems['sync-system'].instantiate('key4 gold', scene, scene, 'keyPart4');
					scene.systems['sync-system'].instantiate('key5 gold', scene, scene, 'keyPart5');
				});
				keySpawn.object3D.addEventListener('jointcollisionleave', function(){
					hasKey = false;
					scene.systems['sync-system'].removeLast('keyPart1');
					scene.systems['sync-system'].removeLast('keyPart2');
					scene.systems['sync-system'].removeLast('keyPart3');
					scene.systems['sync-system'].removeLast('keyPart4');
					scene.systems['sync-system'].removeLast('keyPart5');
				});

				door.object3D.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({ jointCubeSize: 0.1, joints: [['Hand', 'Right', 0]]}));
				door.object3D.addEventListener('jointcollisionenter', function(){
					if (doorState == 'closed' && hasKey) {
						sync.instance.child('doorState').set('opened');
						setTimeout(function(){
				      sync.instance.child('doorState').set('closed');
				    }, 6000);
					}
				});
			}
			//bunnyHat
			scene.systems['sync-system'].instantiate('bunnyHat', scene, scene);
		});

		btn1.addEventListener('mouseup', function(){
			if (doorState == 'closed' && granted) {
				sync.instance.child('doorState').set('opened');
				setTimeout(function(){
		      sync.instance.child('doorState').set('closed');
		    }, 6000);
			}
		});

		sync.instance.child('doorState').on('value', function(data){
			console.log(data.val());
			if (doorState == 'closed' && data.val() == 'opened') {
				doorState = 'opened'
				door.emit('open');
				noEntry.setAttribute('color', 'green');
			}
			if (doorState == 'opened' && data.val() == 'closed') {
				doorState = 'closed';
				door.emit('close');
				setTimeout(function(){
		      noEntry.setAttribute('color', 'red');
		    }, 3000);
			}
		});

		var canRing = true;
		btn2.addEventListener('mousedown', function(){
			if (canRing) {
				bell.components.sync.takeOwnership();
	      bell.components['n-sound'].playSound();
	      canRing = false;
	      setTimeout(function(){
		      canRing = true;
		    }, 10000);
	    }
		});
	});
</script>
</body>
</html>