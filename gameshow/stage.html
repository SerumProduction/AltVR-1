<!DOCTYPE html>
<html>
<head>
	<title>GameShow Test</title>
	<script src="https://aframe.io/releases/0.7.0/aframe.js"></script>
	<script src="https://sdk.altvr.com/libs/altspace.js/2.9.0/altspace.min.js"></script>
</head>
<body>
	<a-scene altspace='fullspace: true' sync-system='author: BenG; app: quizStage; refUrl: https://altvr-apps.firebaseio.com/'>
		<a-entity n-layout-browser='url: https://shanesedit.org/r/mc; isEnclosure: true'></a-entity>
		<a-plane position='0 0 0' scale='20 20 0' rotation='-90 0 0' material='visible: false' n-mesh-collider='type: environment; convex: false'></a-plane>
		<!-- <a-cylinder position='0 -.24 0' height='.6' radius='4.05' color='#101' opacity='.9' n-mesh-collider='type: environment; convex: false'></a-cylinder> -->

		<a-entity id='screenContainer' position='0 -.5 0'>
			<a-entity id='screen' position='0 4.5 -4' scale='.5 .5 .5'>
				<!-- <a-plane scale='15 9 1' color='black' side='double' altspace-cursor-collider='enabled: false'></a-plane> -->
				<!-- <a-plane scale='16 8 1' color='black' side='double' altspace-cursor-collider='enabled: false'></a-plane> -->
				
				<a-box position='0 0 -.1' scale='15 9 .2' color='black'></a-box>
				<a-box position='0 0 -.1' scale='16 8 .2' color='black'></a-box>

				<a-cylinder position='-7.5 4 -.1' rotation='90 0 0' height='.2' radius='.5' segments-height='1' color='black' altspace-cursor-collider='enabled: false'></a-cylinder>
				<a-cylinder position='-7.5 -4 -.1' rotation='90 0 0' height='.2' radius='.5' segments-height='1' color='black' altspace-cursor-collider='enabled: false'></a-cylinder>
				<a-cylinder position='7.5 4 -.1' rotation='90 0 0' height='.2' radius='.5' segments-height='1' color='black' altspace-cursor-collider='enabled: false'></a-cylinder>
				<a-cylinder position='7.5 -4 -.1' rotation='90 0 0' height='.2' radius='.5' segments-height='1' color='black' altspace-cursor-collider='enabled: false'></a-cylinder>

				<a-entity position='0 -3.5 -.25' rotation='0 180 0' n-text='fontSize: 7; text: v0.11'></a-entity>

				<a-entity id='titleScreen' position='0 0 0'>
					<a-entity position='0 0 .1' scale='2 2 2' n-text='text: Logo\ngoes here'></a-entity>
				</a-entity>

				<a-entity id='gameScreen' position='0 0 -.2'>
					<a-plane position='-3.7 -1.5 .1' scale='6.8 1.3 1' color='black' altspace-cursor-collider='enabled: false'></a-plane>
					<a-plane position='3.7 -1.5 .1' scale='6.8 1.3 1' color='black' altspace-cursor-collider='enabled: false'></a-plane>
					<a-plane position='-3.7 -3.2 .1' scale='6.8 1.3 1' color='black' altspace-cursor-collider='enabled: false'></a-plane>
					<a-plane position='3.7 -3.2 .1' scale='6.8 1.3 1' color='black' altspace-cursor-collider='enabled: false'></a-plane>

					<a-plane id='aBScreen' position='-3.7 -1.5 .05' scale='7 1.5 1' color='white' altspace-cursor-collider='enabled: false'></a-plane>
					<a-plane id='bBScreen' position='3.7 -1.5 .05' scale='7 1.5 1' color='white' altspace-cursor-collider='enabled: false'></a-plane>
					<a-plane id='cBScreen' position='-3.7 -3.2 .05' scale='7  1.5 1' color='white' altspace-cursor-collider='enabled: false'></a-plane>
					<a-plane id='dBScreen' position='3.7 -3.2 .05' scale='7 1.5 1' color='white' altspace-cursor-collider='enabled: false'></a-plane>

					<a-entity id='questionTScreen' position='0 1.75 .1' n-text='width: 14; height: 4; fontSize: 7; verticalAlign: center; text: ?'></a-entity>

					<a-entity id='aTScreen' position='-3.7 -1.5 .15' n-text='width: 6.5; height: .1; horizontalAlign: left; fontSize: 5; text: A: '></a-entity>
					<a-entity id='bTScreen' position='3.7 -1.5 .15' n-text='width: 6.5; height: .1; horizontalAlign: left; fontSize: 5; text: B: '></a-entity>
					<a-entity id='cTScreen' position='-3.7 -3.2 .15' n-text='width: 6.5; height: .1; horizontalAlign: left; fontSize: 5; text: C: '></a-entity>
					<a-entity id='dTScreen' position='3.7 -3.2 .15' n-text='width: 6.5; height: .1; horizontalAlign: left; fontSize: 5; text: D: '></a-entity>
				</a-entity>

				<a-entity id='endScreen' position='0 0 -.2'>
					<a-entity id='endGameText' position='0 0 .1' scale='2 2 2' n-text='text: Winner:\nPlayer 1''></a-entity>
				</a-entity>
			</a-entity>
		</a-entity>

		
		<a-entity id='hostPodium' position='2.3 .06 -1.2' rotation='0 105 0'>
			<!-- <a-box position='0 .6 0' scale='.5 1.2 .5' color='#666'></a-box> -->
			<!-- <a-box position='0 1.2 0' scale='.6 .6 .2' rotation='-70 0 0' color='#555'></a-box> -->

			<a-box id='hostJoin' position='0 .9 .25' scale='.05 .05 .05' color='red' n-box-collider='type: hologram'></a-box>

			<a-entity position='0 1.28 -.08' rotation='-73.5 0 0' scale='.03 .03 .03'>
				<a-plane scale='16 9 1' color='#666' n-mesh-collider='type: hologram; convex: false'></a-plane>

				<a-entity id='titleScreen2' position='0 0 0'>
					<a-entity position='0 0 .1' scale='2 2 2' n-text='text: Logo\ngoes here'></a-entity>
					<a-entity id='questionLoadText' position='0 -3.5 .1' n-text='fontSize: 7; text: Questions not loaded'></a-entity>
				</a-entity>

				<a-entity id='gameScreen2' position='0 0 -.2'>
					<a-plane position='-3.7 -1.5 .1' scale='6.8 1.3 1' color='black' altspace-cursor-collider='enabled: false'></a-plane>
					<a-plane position='3.7 -1.5 .1' scale='6.8 1.3 1' color='black' altspace-cursor-collider='enabled: false'></a-plane>
					<a-plane position='-3.7 -3.2 .1' scale='6.8 1.3 1' color='black' altspace-cursor-collider='enabled: false'></a-plane>
					<a-plane position='3.7 -3.2 .1' scale='6.8 1.3 1' color='black' altspace-cursor-collider='enabled: false'></a-plane>

					<a-plane id='aB' position='-3.7 -1.5 .05' scale='7 1.5 1' color='white' n-mesh-collider='type: hologram; convex: false'></a-plane>
					<a-plane id='bB' position='3.7 -1.5 .05' scale='7 1.5 1' color='white' n-mesh-collider='type: hologram; convex: false'></a-plane>
					<a-plane id='cB' position='-3.7 -3.2 .05' scale='7  1.5 1' color='white' n-mesh-collider='type: hologram; convex: false'></a-plane>
					<a-plane id='dB' position='3.7 -3.2 .05' scale='7 1.5 1' color='white' n-mesh-collider='type: hologram; convex: false'></a-plane>

					<a-entity id='questionT' position='0 1.75 .1' n-text='width: 14; height: 4; fontSize: 7; verticalAlign: center; text: ?'></a-entity>

					<a-entity id='aT' position='-3.7 -1.5 .15' n-text='width: 6.5; height: .1; horizontalAlign: left; fontSize: 5; text: A: '></a-entity>
					<a-entity id='bT' position='3.7 -1.5 .15' n-text='width: 6.5; height: .1; horizontalAlign: left; fontSize: 5; text: B: '></a-entity>
					<a-entity id='cT' position='-3.7 -3.2 .15' n-text='width: 6.5; height: .1; horizontalAlign: left; fontSize: 5; text: C: '></a-entity>
					<a-entity id='dT' position='3.7 -3.2 .15' n-text='width: 6.5; height: .1; horizontalAlign: left; fontSize: 5; text: D: '></a-entity>
				</a-entity>

				<a-entity id='endScreen2' position='0 0 -.2'>
					<a-entity id='endGameText2' position='0 0 .1' scale='2 2 2' n-text='text: Winner:\nPlayer 1'></a-entity>
				</a-entity>

				<a-cylinder id='hostNext' position='0 -7 0' rotation='90 0 0' radius='1.5' color='#282' segments-height='1' n-mesh-collider='type: hologram; convex: false'></a-cylinder>

				<a-entity position='20 0 0'>
					<a-entity position='0 -5 0' n-text='fontSize: 10; text: To be removed'></a-entity>
					
					<a-box id='next' position='5 -7 0' scale='1 1 .5' color='blue' n-text='fontSize: 5; horizontalAlign: left; text: Next Question' n-box-collider='type: hologram'></a-box>
					<a-box id='confirmB' position='-2 -7 0' scale='1 1 .5' color='green' n-text='fontSize: 5; horizontalAlign: left; text: Confirm Answer' n-box-collider='type: hologram'></a-box>
					<a-box id='categoryB' position='5 -9 0' scale='1 1 .5' color='yellow' n-text='fontSize: 5; horizontalAlign: left; text: Select Category' n-box-collider='type: hologram'></a-box>
					<a-box id='resetKey' position='-2 -9 0' scale='1 1 .5' color='red' n-text='fontSize: 5; horizontalAlign: left; text: Reset API Key' n-box-collider='type: hologram'></a-box>
				</a-entity>

				<a-box id='endGameB' position='-7 -9 0' scale='1 1 .5' color='red' n-text='fontSize: 5; horizontalAlign: right; width: 7; text: End Game' n-box-collider='type: hologram'></a-box>
				<a-box id='resetB' position='7 -9 0' scale='1 1 .5' color='black' n-text='fontSize: 5; horizontalAlign: left; width: 9; text: Reset Buzzers' n-box-collider='type: hologram'></a-box>
			</a-entity>
		</a-entity>

		<a-entity id='newPodiums' position='-1.6 .06 -1.6' rotation='0 45 0'>
			<a-entity id='podium1' position='-1.6 0 0'>
				<a-entity position='0 1 .235' rotation='8 0 0'>
					<a-entity id='p1Name' position='0 .23 .005' scale='.75 .75 .75' n-text='width: 0.5; fontSize: 1; text: <color=black>Player 1'></a-entity>
					<a-entity id='p1Score' position='0 0 .005' scale='.9 .9 .9' n-text='fontSize: 3; text: <color=black>1'></a-entity>
				</a-entity>
				<a-box id='p1Join' class='joinButton' position='0 .9 -.22' scale='.05 .05 .05' color='red' n-box-collider='type: hologram'></a-box>
			</a-entity>

			<a-entity id='podium2' position='-.8 0 0'>
				<a-entity position='0 1 .235' rotation='8 0 0'>
					<a-entity id='p2Name' position='0 .23 .005' scale='.75 .75 .75' n-text='width: 0.5; fontSize: 1; text: <color=black>Player 2'></a-entity>
					<a-entity id='p2Score' position='0 0 .005' scale='.9 .9 .9' n-text='fontSize: 3; text: <color=black>2'></a-entity>
				</a-entity>
				<a-box id='p2Join' class='joinButton' position='0 .9 -.22' scale='.05 .05 .05' color='red' n-box-collider='type: hologram'></a-box>
			</a-entity>

			<a-entity id='podium3' position='0 0 0'>
				<a-entity position='0 1 .235' rotation='8 0 0'>
					<a-entity id='p3Name' position='0 .23 .005' scale='.75 .75 .75' n-text='width: 0.5; fontSize: 1; text: <color=black>Player 3'></a-entity>
					<a-entity id='p3Score' position='0 0 .005' scale='.9 .9 .9' n-text='fontSize: 3; text: <color=black>3'></a-entity>
				</a-entity>
				<a-box id='p3Join' class='joinButton' position='0 .9 -.22' scale='.05 .05 .05' color='red' n-box-collider='type: hologram'></a-box>
			</a-entity>

			<a-entity id='podium4' position='.8 0 0'>
				<a-entity position='0 1 .235' rotation='8 0 0'>
					<a-entity id='p4Name' position='0 .23 .005' scale='.75 .75 .75' n-text='width: 0.5; fontSize: 1; text: <color=black>Player 4'></a-entity>
					<a-entity id='p4Score' position='0 0 .005' scale='.9 .9 .9' n-text='fontSize: 3; text: <color=black>4'></a-entity>
				</a-entity>
				<a-box id='p4Join' class='joinButton' position='0 .9 -.22' scale='.05 .05 .05' color='red' n-box-collider='type: hologram'></a-box>
			</a-entity>

			<a-entity id='podium5' position='1.6 0 0'>
				<a-entity position='0 1 .235' rotation='8 0 0'>
					<a-entity id='p5Name' position='0 .23 .005' scale='.75 .75 .75' n-text='width: 0.5; fontSize: 1; text: <color=black>Player 5'></a-entity>
					<a-entity id='p5Score' position='0 0 .005' scale='.9 .9 .9' n-text='fontSize: 3; text: <color=black>5'></a-entity>
				</a-entity>
				<a-box id='p5Join' class='joinButton' position='0 .9 -.22' scale='.05 .05 .05' color='red' n-box-collider='type: hologram'></a-box>
			</a-entity>

			<a-box id='contestantContainer1' position='-2 1 -1' scale='2 2 2' material='visible: false' opacity='.01' altspace-cursor-collider='enabled: false'></a-box>
			<a-box id='contestantContainer2' position='0 1 -1' scale='2 2 2' material='visible: false' opacity='.01' altspace-cursor-collider='enabled: false'></a-box>
			<a-box id='contestantContainer3' position='2 1 -1' scale='2 2 2' material='visible: false' opacity='.01' altspace-cursor-collider='enabled: false'></a-box>

		</a-entity>


		<a-entity id='sound'></a-entity>
		<a-entity id='correct' sync sync-n-sound></a-entity>
		<a-entity id='incorrect' sync sync-n-sound></a-entity>

	</a-scene>
<script>
	var scene = document.querySelector('a-scene');
	scene.addEventListener('connected', function() {
  	var sync = scene.systems['sync-system'].connection;

	sound.setAttribute('n-sound', {src: /Mobile/i.test(navigator.userAgent) ? 'https://bengarfield.github.io/AltVR/Hive/sounds/ding.mp3' : 'https://bengarfield.github.io/AltVR/Hive/sounds/ding.ogg', volume: 0.3, spatialBlend: 0.5});
	correct.setAttribute('n-sound', {src: /Mobile/i.test(navigator.userAgent) ? 'https://bengarfield.github.io/AltVR/codenames/sounds/win2.mp3' : 'https://bengarfield.github.io/AltVR/codenames/sounds/win2.ogg', volume: 0.3, spatialBlend: 0.5});
	incorrect.setAttribute('n-sound', {src: /Mobile/i.test(navigator.userAgent) ? 'https://bengarfield.github.io/AltVR/codenames/sounds/fail.mp3' : 'https://bengarfield.github.io/AltVR/codenames/sounds/fail.ogg', volume: 0.3, spatialBlend: 0.5});


	var scores = [];
	var categories = [{id:9,name:'General Knowledge'},{id:10,name:'Books'},{id:11,name:'Film'},{id:12,name:'Music'},{id:13,name:'Musicals & Theatres'},{id:14,name:'Television'},{id:15,name:'Video Games'},{id:16,name:'Board Games'},{id:17,name:'Science & Nature'},{id:18,name:'Computers'},{id:19,name:'Mathematics'},{id:20,name:'Mythology'},{id:21,name:'Sports'},{id:22,name:'Geography'},{id:23,name:'History'},{id:24,name:'Politics'},{id:25,name:'Art'},{id:26,name:'Celebrities'},{id:27,name:'Animals'},{id:28,name:'Vehicles'},{id:29,name:'Comics'},{id:30,name:'Gadgets'},{id:31,name:'Japanese Anime & Manga'},{id:32,name:'Cartoon & Animations'}];
	var podiumList = [];

	altspace.getUser().then(function(user){
		var loader = new THREE.OBJLoader();
		loader.load('models/podiumTall.obj', podiumLoad, undefined, undefined);
		loader.load('models/hostPodium.obj', hostPodiumLoad, undefined, undefined);
		loader.load('models/stage.obj', stageLoad, undefined, undefined);

		function stageLoad(obj) {
			console.log('stage', obj);

			var stage = new THREE.Color(.15,0,.3);

			obj.getObjectByName('Cylinder').material = new THREE.MeshBasicMaterial({color: stage, map: new THREE.TextureLoader().load('models/stage.png')});
			obj.getObjectByName('Cylinder').userData.altspace = {collider: {enabled: false}};
			scene.object3D.add(obj);
		}

		function hostPodiumLoad(obj) {
			console.log('host', obj);
			obj.rotation.y = Math.PI/2;
			obj.scale.setScalar(.5);
			obj.position.y = 0.1;


			var blue = new THREE.Color(0,.15,.4);
			//var blue = new THREE.Color(.2,0,.1);

			obj.getObjectByName('base').material = new THREE.MeshBasicMaterial({color: blue, map: new THREE.TextureLoader().load('models/hostBase.png')});
			obj.getObjectByName('screen').material = new THREE.MeshBasicMaterial({color: 0x000000});
			//obj.getObjectByName('stripes').material = new THREE.MeshBasicMaterial({color: 0x000000});

			//obj.remove(obj.getObjectByName('screen'));

			obj.getObjectByName('screen').userData.altspace = {collider: {enabled: false}};

			hostPodium.object3D.add(obj);
		}

		function podiumLoad(obj) {
			console.log('podium OBJ loaded')
			console.log(obj);
			obj.rotation.y = -Math.PI/2;
			obj.scale.setScalar(.5);
			obj.position.y = 0.1;

			var blue = new THREE.Color(0,.2,.5);
			var red = new THREE.Color(1,0,0);
			var white = new THREE.Color(1,1,1);
			var grey = new THREE.Color(.6,.6,.6);

			var darkBlue = new THREE.Color(0,.12,.3);
			obj.getObjectByName('stripes').material.color.set(darkBlue);
			obj.getObjectByName('panels').material.color.set(darkBlue);

			for (var i = 1; i < 6; i++) {
				var p = obj.clone();

				p.getObjectByName('base').material = new THREE.MeshBasicMaterial({color: blue, map: new THREE.TextureLoader().load('models/podium' + i + '.png')});
				p.getObjectByName('button').material = new THREE.MeshBasicMaterial({color: red, map: new THREE.TextureLoader().load('models/podium' + i + '.png')});

				p.getObjectByName('stripes').material = new THREE.MeshBasicMaterial({map: new THREE.TextureLoader().load('models/light.png')});
				p.getObjectByName('panels').material = new THREE.MeshBasicMaterial({color: grey});

				document.querySelector('#podium' + i).object3D.add(p);
				podiumList.push(p);
			}

			
			function setPanelLight(p,on) {
				var panel = podiumList[p].getObjectByName('panels').material;
				if (on) {
					panel.color.set(white);
				} else {
					panel.color.set(grey);
				}
			}


  		var isMod = user.isModerator;
  		var isHost = false;

  		var hasHost = false;
  		sync.instance.child('host').on('value', function(data){
				if (data.val() != null) {
					hasHost = true;
					hostJoin.setAttribute('color', 'green');
					if(data.val().userId == user.userId) {
						isHost = true;
						console.log('You are host!');
					} else {
						isHost = false;
					}
				} else {
					hasHost = false;
					hostJoin.setAttribute('color', 'red');
					isHost = false;
				}
			});
			
			var players = [];
			sync.instance.child('players').on('value', function(data){
				if (data.val() != null) {
					//console.log(data.val());
					players = data.val();
					joined = 0;
					for (var i = 0; i < 5; i++) {
						if (players[i].joined) {
							document.querySelector('#p' + (i + 1) + 'Name').setAttribute('n-text', 'text', '<color=black>' + data.val()[i].displayName);
							document.querySelector('#p' + (i + 1) + 'Score').setAttribute('n-text', 'text', '<color=black>' + data.val()[i].score);
							document.querySelector('#p' + (i + 1) + 'Join').setAttribute('color', 'green');
							if (!playerBuzzedIn) {
								setPanelLight(i, true);
							}
						} else {
							document.querySelector('#p' + (i + 1) + 'Name').setAttribute('n-text', 'text', '');
							document.querySelector('#p' + (i + 1) + 'Score').setAttribute('n-text', 'text', '');
							document.querySelector('#p' + (i + 1) + 'Join').setAttribute('color', 'red');
							setPanelLight(i, false);
						}
						if (players[i].id == user.userId) {
							console.log(i + ' is you');
							joined = i + 1;
						}
					}
				} else {
					sync.instance.child('players').set([{joined: false},{joined: false},{joined: false},{joined: false},{joined: false}]);
				}
			});

			var podiumLightState = ['off','off','off','off','off'];

			function setColor(p,to) {
				var dur = 500;
				var stripes = podiumList[p].getObjectByName('stripes').material;
				switch (to) {
					case 'off':
						if (podiumLightState[p] == 'buzzed') {
							new TWEEN.Tween(stripes.map.offset).to({y: 0}, dur).start();
						} else if (podiumLightState[p] == 'correct') {
							stripes.map.offset.set(.6,-.5);
							new TWEEN.Tween(stripes.map.offset).to({y: 0}, dur).start();
						} else if (podiumLightState[p] == 'wrong') {
							stripes.map.offset.set(.8,-.5);
							new TWEEN.Tween(stripes.map.offset).to({y: 0}, dur).start();
						} else {
							stripes.map.offset.set(0,0);
						}
						break;
					case 'buzzed':
						if (podiumLightState[p] == 'off') {
							stripes.map.offset.set(0,0);
							new TWEEN.Tween(stripes.map.offset).to({y: -.5}, dur).start();
						} else {
							stripes.map.offset.set(0,-.5);
						}
						break;
					case 'correct':
						if (podiumLightState[p] == 'buzzed') {
							stripes.map.offset.set(.2,0);
							new TWEEN.Tween(stripes.map.offset).to({y: -.5}, dur).start();
						} else {
							stripes.map.offset.set(.2,-.5);
						}
						break;
					case 'wrong':
						if (podiumLightState[p] == 'buzzed') {
							stripes.map.offset.set(.4,0);
							new TWEEN.Tween(stripes.map.offset).to({y: -.5}, dur).start();
						} else {
							stripes.map.offset.set(.4,-.5);
						}
						break;
					case 'winner':
						stripes.map.offset.set(0,0);
						new TWEEN.Tween(stripes.map.offset).to({x: .8, y: -.5}, dur * 10).start();
						break;
				}
				podiumLightState[p] = to;
			}

			var done = false;
			var playerBuzzedIn;
			sync.instance.child('click').on('value', function(data){
	      if (data.val() == null) {
	        for (var i = 0; i < 5; i++) {
	        	setColor(i, 'off');
		        //sync.instance.child('podiumLightState').child(i).set('off');

		        // if not joined set grey, else set white
		        if (players[i].joined) {
		        	setPanelLight(i, true);
		        } else {
			        setPanelLight(i, false);
			      }
	        }
	        done = false;
	        playerBuzzedIn = null;
	      } else {
	        	var p = data.val()[Object.keys(data.val())[0]];
	        	for (var i = 0; i < 5; i++) {
	        		setColor(i, 'off');
			        //sync.instance.child('podiumLightState').child(i).set('off');
			        setPanelLight(i, false);
		        }
		        setColor(p - 1, 'buzzed');
		        //sync.instance.child('podiumLightState').child(p - 1).set('buzzed');
		        setPanelLight(p - 1, true);

	        if (!done) {
	          sound.components['n-sound'].playSound();
	          done = true;
	          playerBuzzedIn = p;
	        }
	      }
	    });

	    var screenState;
	    sync.instance.child('screenState').on('value', function(data){
				if (data.val() != null) {
					screenState = data.val();

					titleScreen.setAttribute('position', '0 0 -.2');
					gameScreen.setAttribute('position', '0 0 -.2');
					endScreen.setAttribute('position', '0 0 -.2');

					titleScreen2.setAttribute('position', '0 0 -.2');
					gameScreen2.setAttribute('position', '0 0 -.2');
					endScreen2.setAttribute('position', '0 0 -.2');

					if (screenState == 1) {
						titleScreen.setAttribute('position', '0 0 0');
						titleScreen2.setAttribute('position', '0 0 0');
					} else if (screenState == 2) {
						gameScreen.setAttribute('position', '0 0 0');
						gameScreen2.setAttribute('position', '0 0 0');
					} else {
						var winner;
						for (var i = 0; i < 5; i++) {
							if (players[i].joined) {
								if (winner == null || players[i].score > winner.score) {
									winner = players[i];
								}
							}
						}
						endGameText.setAttribute('n-text', 'text', 'Winner:\n' + winner.displayName);
						endGameText2.setAttribute('n-text', 'text', 'Winner:\n' + winner.displayName);

						endScreen.setAttribute('position', '0 0 0');
						endScreen2.setAttribute('position', '0 0 0');
					}

				} else {
					sync.instance.child('screenState').set(1);
				}
			});

			var mode;
			sync.instance.child('mode').on('value', function(data){
				if (data.val() != null) {
					mode = data.val();
				} else {
					sync.instance.child('mode').set('category');
				}
			});

			var currentCategory;
			sync.instance.child('category').on('value', function(data){
				if (data.val() != null) {
					currentCategory = data.val();
					console.log('Current Catergory:', currentCategory);
				}
			});

			sync.instance.child('categoriesDone').on('child_added', function(data){
				console.log('Catergory chosen:', data.val().name);

				for (var i = 0; i < categories.length; i++) {
					if (categories[i].id == data.val().id) {
						console.log(i, categories[i]);
						categories.splice(i, 1);
					}
				}

				console.log('Categories left:', categories);
			});

			var categoriesOnScreen;
			sync.instance.child('categories').on('value', function(data){
				if (data.val() != null) {
					//mode = data.val();
					console.log(data.val());
					categoriesOnScreen = data.val();
					if (mode == 'category') {
						console.log(true);
						questionT.setAttribute('n-text', 'text', 'Select a Category');
						aT.setAttribute('n-text', 'text', data.val()[0]);
				    bT.setAttribute('n-text', 'text', data.val()[1]);
				    cT.setAttribute('n-text', 'text', data.val()[2]);
				    dT.setAttribute('n-text', 'text', data.val()[3]);

				    questionTScreen.setAttribute('n-text', 'text', 'Select a Category');
				    aTScreen.setAttribute('n-text', 'text', data.val()[0]);
				    bTScreen.setAttribute('n-text', 'text', data.val()[1]);
				    cTScreen.setAttribute('n-text', 'text', data.val()[2]);
				    dTScreen.setAttribute('n-text', 'text', data.val()[3]);
					}

					if (screenState != 3) {
						sync.instance.child('screenState').set(2);
					}
				}
			});

			sync.instance.child('questions').on('value', function(data){
				if (data.val() != null) {
					questions = data.val();

					questionsLoaded = true;
					clicked = true;
			  	questionLoadText.setAttribute('n-text', 'text', 'Questions loaded');
				}
			});

			sync.instance.child('current').on('value', function(data){
				if (data.val() != null) {
					current = data.val();
					if (current != -1 && mode == 'question') {
						nextQ(current);
					} else {
						//reset();
					}
				} else {
					sync.instance.child('current').set(-1);
				}
			});

			sync.instance.child('selectedAnswer').on('value', function(data){
				aB.setAttribute('color', '#fff');
				bB.setAttribute('color', '#fff');
				cB.setAttribute('color', '#fff');
				dB.setAttribute('color', '#fff');
				aBScreen.setAttribute('color', '#fff');
				bBScreen.setAttribute('color', '#fff');
				cBScreen.setAttribute('color', '#fff');
				dBScreen.setAttribute('color', '#fff');
				if (data.val() != null) {
					document.querySelector('#' + data.val() + 'B').setAttribute('color', '#0af');
					document.querySelector('#' + data.val() + 'BScreen').setAttribute('color', '#0af');
				}
				selected = data.val();
			});

			var answered;
			sync.instance.child('answered').on('value', function(data){
				if (data.val()) {
					document.querySelector('#' + answer + 'B').setAttribute('color', 'green');
					document.querySelector('#' + answer + 'BScreen').setAttribute('color', 'green');
					if (selected != answer && selected != null) {
						document.querySelector('#' + selected + 'B').setAttribute('color', 'red');
						document.querySelector('#' + selected + 'BScreen').setAttribute('color', 'red');
						setColor(playerBuzzedIn - 1, 'wrong');
						//sync.instance.child('podiumLightState').child(playerBuzzedIn - 1).set('wrong');
					} else if (selected == answer) {
						setColor(playerBuzzedIn - 1, 'correct');
						//sync.instance.child('podiumLightState').child(playerBuzzedIn - 1).set('correct');
					}
				}
				answered = data.val();
			});

			sync.instance.child('apiKey').on('value', function(data){
				if (data.val() != null) {
					apiKey = data.val();
				} else {
					var dataRequest = (THREE.FileLoader ? new THREE.FileLoader() : new THREE.XHRLoader(/* DEPRECATED: r83 */));
					dataRequest.load('https://opentdb.com/api_token.php?command=request', onLoaded, undefined, undefined);
					function onLoaded(obj) {
				    var data = JSON.parse(obj);
				    console.log(data);
				    if (data['response_code'] == 0) {
				    	sync.instance.child('apiKey').set(data.token);
				    }
				  }
				}
			});

			contestantContainer1.object3D.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
		    joints: [['Head','Center',0]],
		    jointCubeSize: .01
		  }));
		  contestantContainer2.object3D.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
		    joints: [['Head','Center',0]],
		    jointCubeSize: .01
		  }));
		  contestantContainer3.object3D.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
		    joints: [['Head','Center',0]],
		    jointCubeSize: .01
		  }));

		  var contPos = [false,false,false];
		  var screenPos = 0;

		  contestantContainer1.object3D.addEventListener('jointcollisionenter', function(e){
		    contPos[0] = true;
		    checkPos();
		  });
		  contestantContainer2.object3D.addEventListener('jointcollisionenter', function(e){
		    contPos[1] = true;
		    checkPos();
		  });
		  contestantContainer3.object3D.addEventListener('jointcollisionenter', function(e){
		    contPos[2] = true;
		    checkPos();
		  });

		  contestantContainer1.object3D.addEventListener('jointcollisionleave', function(e){
		    contPos[0] = false;
		    checkPos();
		  });
		  contestantContainer2.object3D.addEventListener('jointcollisionleave', function(e){
		    contPos[1] = false;
		    checkPos();
		  });
		  contestantContainer3.object3D.addEventListener('jointcollisionleave', function(e){
		    contPos[2] = false;
		    checkPos();
		  });

		  function checkPos() {
		  	if (screenPos == 0 && (contPos[0] || contPos[1] || contPos[2])) {
		  		moveScreen(1);
		  	} else if (screenPos == 1 && !contPos[0] && !contPos[1] && !contPos[2]) {
		  		moveScreen(0);
		  	}
		  }

		  function moveScreen(i) {
		  	screenPos = i;
		  	var a = [{pos:{x:0,y:-0.5,z:0}, scale:{x:1,y:1,z:1}, rot:{x:0,y:0,z:0}}, {pos:{x:0,y:0.1,z:0}, scale:{x:0.35,y:0.35,z:0.35}, rot:{x:THREE.Math.degToRad(-20),y:THREE.Math.degToRad(-135),z:THREE.Math.degToRad(0)}}];

		  	new TWEEN.Tween(screenContainer.object3D.position).to(a[i].pos, 1000).start();
		  	new TWEEN.Tween(screenContainer.object3D.scale).to(a[i].scale, 1000).start();
		  	new TWEEN.Tween(screenContainer.object3D.rotation).to(a[i].rot, 1000).start();
		  }

      podiumList[0].getObjectByName('button').addEventListener('cursordown', function(){
      	buzz(1);
      });
      podiumList[1].getObjectByName('button').addEventListener('cursordown', function(){
      	buzz(2);
      });
      podiumList[2].getObjectByName('button').addEventListener('cursordown', function(){
      	buzz(3);
      });
      podiumList[3].getObjectByName('button').addEventListener('cursordown', function(){
      	buzz(4);
      });
      podiumList[4].getObjectByName('button').addEventListener('cursordown', function(){
      	buzz(5);
      });

      podiumList[0].getObjectByName('button').addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
        joints: [['Index','Right',3],['Index','Left',3],['Hand','Right',0],['Hand','Left',0]],
        jointCubeSize: .02
      }));
      podiumList[1].getObjectByName('button').addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
        joints: [['Index','Right',3],['Index','Left',3],['Hand','Right',0],['Hand','Left',0]],
        jointCubeSize: .02
      }));
      podiumList[2].getObjectByName('button').addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
        joints: [['Index','Right',3],['Index','Left',3],['Hand','Right',0],['Hand','Left',0]],
        jointCubeSize: .02
      }));
      podiumList[3].getObjectByName('button').addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
        joints: [['Index','Right',3],['Index','Left',3],['Hand','Right',0],['Hand','Left',0]],
        jointCubeSize: .02
      }));
      podiumList[4].getObjectByName('button').addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
        joints: [['Index','Right',3],['Index','Left',3],['Hand','Right',0],['Hand','Left',0]],
        jointCubeSize: .02
      }));

      podiumList[0].getObjectByName('button').addEventListener('jointcollisionenter', function(e){
        buzz(1);
      });
      podiumList[1].getObjectByName('button').addEventListener('jointcollisionenter', function(e){
        buzz(2);
      });
      podiumList[2].getObjectByName('button').addEventListener('jointcollisionenter', function(e){
        buzz(3);
      });
      podiumList[3].getObjectByName('button').addEventListener('jointcollisionenter', function(e){
        buzz(4);
      });
      podiumList[4].getObjectByName('button').addEventListener('jointcollisionenter', function(e){
        buzz(5);
      });

      function buzz(i) {
      	if (joined == i && playerBuzzedIn == null && mode == 'question') {
          sync.instance.child('click').push(i.toString());
        }
      }

			function reset() {
				aB.setAttribute('color', 'white');
				bB.setAttribute('color', 'white');
				cB.setAttribute('color', 'white');
				dB.setAttribute('color', 'white');

				aT.setAttribute('n-text', 'text', 'A:');
		    bT.setAttribute('n-text', 'text', 'B:');
		    cT.setAttribute('n-text', 'text', 'C:');
		    dT.setAttribute('n-text', 'text', 'D:');

		    questionT.setAttribute('n-text', 'text', '?');
			}
		

			var answer;
			var questions = {pre_game: {questions: []}};
			var current;
			var selected;

			var isHost = false;

			var apiKey = '';

			var questionsLoaded = false;
			function getAllQuestions() {
		  	var dataRequest = new THREE.FileLoader();
				dataRequest.load('https://opentdb.com/api_token.php?command=request&' + Math.random().toString(), function(obj){
			    var token = JSON.parse(obj).token;
			  	var i = 0;
			  	function next() {
				  	dataRequest.load('https://opentdb.com/api.php?amount=10&type=multiple&encode=url3986&category=' + categories[i].id + '&token=' + token + '&' + Math.random().toString(), function(obj){
			  			var data = JSON.parse(obj);
			  			decode(data);
			  			sortAnswers(data.results);
			  			console.log(Math.round((i + 1) / (categories.length + 3) * 100) + '%');
			  			questionLoadText.setAttribute('n-text', 'text', Math.round((i + 1) / (categories.length + 3) * 100) + '%');
			  			questions[categories[i].id.toString()] = {category: categories[i].name, questions: data.results};

			  			if (i < categories.length - 1) {
			  				i++;
			  				next();
			  			} else {
			  				var c = 0;
			  				var pregame = [{diff:'easy',amm:4},{diff:'medium',amm:3},{diff:'hard',amm:3}];
			  				function getPreGameQuestions() {
			  					dataRequest.load('https://opentdb.com/api.php?amount=' + pregame[c].amm + '&difficulty=' + pregame[c].diff + '&type=multiple&encode=url3986&token=' + token + '&' + Math.random().toString(), function(obj){
			  						var data = JSON.parse(obj);
						  			decode(data);
						  			sortAnswers(data.results);
						  			/*for (var x = 0; x < data.results.length; x++) {
						  				questions.pre_game.questions.push(data.results[x]);
						  			}*/
						  			data.results.forEach(function(q){
						  				questions.pre_game.questions.push(q);
						  			});

						  			console.log(Math.round((i + 1 + c + 1) / (categories.length + 3) * 100) + '%');
						  			questionLoadText.setAttribute('n-text', 'text', Math.round((i + 1 + c + 1) / (categories.length + 3) * 100) + '%');
						  			if (c < pregame.length - 1) {
						  				c++;
						  				getPreGameQuestions();
						  			} else {
						  				console.log(questions);
						  				questionLoadText.setAttribute('n-text', 'text', 'Questions loaded');
						  				sync.instance.child('questions').set(questions);
						  				questionsLoaded = true;
						  			}
			  					}, undefined, undefined);
			  				}
			  				getPreGameQuestions();
			  			}
			  		}, undefined, undefined);
			  	}
			  	next();
			  }, undefined, undefined);
		  }

		  function sortAnswers(list) {
		  	for (var i = 0; i < list.length; i++) {
		  		var c = Math.floor(Math.random() * 4);
			    var answers = list[i].incorrect_answers
			    shuffleArray(answers);

			    answers.splice(c, 0, list[i].correct_answer);

			    if (c == 0) {
			    	list[i].correct_answer = 'a';
			    } else if (c == 1) {
			    	list[i].correct_answer = 'b';
			    } else if (c == 2) {
			    	list[i].correct_answer = 'c';
			    } else if (c == 3) {
			    	list[i].correct_answer = 'd';
			    }
			    list[i].answers = list[i].incorrect_answers;
			    delete list[i].incorrect_answers;
			    delete list[i].category;
		  		delete list[i].type;
		  		//delete list[i].difficulty;
		  	}
		  }

		  function nextQ(c) {
		  	current = c;
		  	console.log('Question ' + (current + 1));
		  	answered = false;

		  	aB.setAttribute('color', '#fff');
				bB.setAttribute('color', '#fff');
				cB.setAttribute('color', '#fff');
				dB.setAttribute('color', '#fff');
			
				aBScreen.setAttribute('color', '#fff');
				bBScreen.setAttribute('color', '#fff');
				cBScreen.setAttribute('color', '#fff');
				dBScreen.setAttribute('color', '#fff');

		    console.log(questions[currentCategory].questions[current].difficulty);
		    console.log(questions[currentCategory].questions[current].question);

		    questionT.setAttribute('n-text', 'text', (current + 1) +  ': ' + questions[currentCategory].questions[current].question);
		    questionTScreen.setAttribute('n-text', 'text', questions[currentCategory].questions[current].question);

		    var answers = questions[currentCategory].questions[current].answers

		    var sizes = getSizes(answers);
		    
		    aT.setAttribute('n-text', 'text', 'A: ' + answers[0]);
		    bT.setAttribute('n-text', 'text', 'B: ' + answers[1]);
		    cT.setAttribute('n-text', 'text', 'C: ' + answers[2]);
		    dT.setAttribute('n-text', 'text', 'D: ' + answers[3]);

		    aTScreen.setAttribute('n-text', 'text', 'A: ' + answers[0]);
		    bTScreen.setAttribute('n-text', 'text', 'B: ' + answers[1]);
		    cTScreen.setAttribute('n-text', 'text', 'C: ' + answers[2]);
		    dTScreen.setAttribute('n-text', 'text', 'D: ' + answers[3]);

		    aT.setAttribute('n-text', 'fontSize', sizes[0]);
		    bT.setAttribute('n-text', 'fontSize', sizes[1]);
		    cT.setAttribute('n-text', 'fontSize', sizes[2]);
		    dT.setAttribute('n-text', 'fontSize', sizes[3]);

		    aTScreen.setAttribute('n-text', 'fontSize', sizes[0]);
		    bTScreen.setAttribute('n-text', 'fontSize', sizes[1]);
		    cTScreen.setAttribute('n-text', 'fontSize', sizes[2]);
		    dTScreen.setAttribute('n-text', 'fontSize', sizes[3]);

		    answer = questions[currentCategory].questions[current].correct_answer;
		  }

		  function categorySelect() {
		  	questionT.setAttribute('n-text', 'text', 'Select a Category');
		  	aT.setAttribute('n-text', 'text', categories[0].name);
		  	bT.setAttribute('n-text', 'text', categories[1].name);
		  	cT.setAttribute('n-text', 'text', categories[2].name);
		  	dT.setAttribute('n-text', 'text', categories[3].name);

		  	questionTScreen.setAttribute('n-text', 'text', 'Select a Category');
		  	aTScreen.setAttribute('n-text', 'text', categories[0].name);
		  	bTScreen.setAttribute('n-text', 'text', categories[1].name);
		  	cTScreen.setAttribute('n-text', 'text', categories[2].name);
		  	dTScreen.setAttribute('n-text', 'text', categories[3].name);
		  }

		  aB.addEventListener('mouseup', function(){
		  	select('a');
		  });
		  bB.addEventListener('mouseup', function(){
		  	select('b');
		  });
		  cB.addEventListener('mouseup', function(){
		  	select('c');
		  });
		  dB.addEventListener('mouseup', function(){
		  	select('d');
		  });

		  function select(a) {
				if (selected == a) {
					selected = null;
				} else {
					selected = a;
				}
				sync.instance.child('selectedAnswer').set(selected);
		  }

		  function getSizes(arr) {
		  	var result = [5,5,5,5];
		  	for ( var i = 0; i < 4; i++) {
			  	if (arr[i].length > 50) {
			  		result[i] = 3;
			  	} else if (arr[i].length > 30) {
			  		result[i] = 4;
		  		}
		  	}
		  	return result;
		  }

		  function checkAnswer(a) {
		  	console.log(a, answer, scores, playerBuzzedIn);
		  	if (a == answer) {
			  	players[playerBuzzedIn - 1].score++;
			  	//playSound(correct);
			  	correct.components['n-sound'].playSound();
			  } else {
			  	players[playerBuzzedIn - 1].score--;
			  	//playsound(wrong);
			  	incorrect.components['n-sound'].playSound();
			  }
			  sync.instance.child('players').set(players);
		  	sync.instance.child('answered').set('true');
		  }


		  var clicked = false;
		  endGameB.addEventListener('mouseup', function(){
		  	if (isHost || isMod) {
			  	//sync.instance.child('current').set(-1);
			  	//getQs(9);

			  	sync.instance.child('categories').set(null);
			  	if (screenState == 3) {
			  		sync.instance.child('screenState').set(1);
			  	} else {
				  	sync.instance.child('screenState').set(3);
				  }
			  }
		  });

		  next.addEventListener('mouseup', function(){
		  	if (isHost || isMod) {
			  	nextQuestion();
				}
		  });

		  function nextQuestion() {
		  	if (current < 9) {
			  	sync.instance.child('current').set(current + 1);
			  }
			  sync.instance.child('answered').set(false);
			  sync.instance.child('selectedAnswer').set(null);
			  sync.instance.child('click').set(null);
		  }

		  var indexes = ['a','b','c','d'];

		  confirmB.addEventListener('mouseup', function(){
				if (!answered && (isHost || isMod)) {
					answerQuestion();
				}
		  });

		  function answerQuestion() {
		  	console.log('selected', selected);
				if (selected != null) {
					if (mode == 'category') {
						console.log(categoriesOnScreen[indexes.indexOf(selected)]);
						//console.log(categories);
						for (var i = 0; i < categories.length; i++) {
							if (categories[i].name == categoriesOnScreen[indexes.indexOf(selected)]) {
								//console.log(categories[i]);
								
								//REPLACE WITH NEW
								//getQs(categories[i].id);

								sync.instance.child('category').set(categories[i].id);
								sync.instance.child('categoriesDone').push(categories[i]);

								sync.instance.child('selectedAnswer').set(null);
				    		sync.instance.child('mode').set('question');
				    		sync.instance.child('current').set(0);
							}
						}
						//sync.instance.child('answered').set(false);
					} else {
						checkAnswer(selected);
					}
				} else {
					sync.instance.child('answered').set(true);
				}
		  }

		  categoryB.addEventListener('mouseup', function(){
		  	if (isHost || isMod) {
					categorySelect();
				}
		  });

		  function categorySelect() {
		  	shuffleArray(categories);
		  	console.log(categories[0].name);
		  	console.log(categories[1].name);
		  	console.log(categories[2].name);
		  	console.log(categories[3].name);
		  	//categorySelect();
		  	sync.instance.child('click').set(null);
		  	sync.instance.child('answered').set(false);
			  sync.instance.child('selectedAnswer').set(null);
		  	sync.instance.child('mode').set('category');
		  	sync.instance.child('categories').set([categories[0].name,categories[1].name,categories[2].name,categories[3].name]);
		  	//console.log(categories);
		  }

		  resetKey.addEventListener('mouseup', function(){
		  	if (isHost || isMod) {
			  	sync.instance.child('apiKey').set(null);
		  	}
		  });

		  resetB.addEventListener('mouseup', function(){
		  	if (isHost || isMod) {
			  	sync.instance.child('click').set(null);
		  	}
		  });


		  hostNext.addEventListener('mouseup', function(){
		  	if (isHost || isMod) {
		  		console.log(current);
		  		if (!questionsLoaded) {
		  			console.log('loadQuestions');
		  			getAllQuestions();
		  		} else if (current == -1 && selected == null || (answered && current == 9) || (mode == 'category' && selected == null)) {
		  			console.log('go to gategory selection');
		  			categorySelect();
		  		} else if (!answered) {
		  			console.log('answer question');
		  			answerQuestion();
		  		} else if ((answered && current < 9) || (mode == 'category' && selected != null)) {
		  			console.log('go to next question');
		  			nextQuestion();
		  		}
		  	}
		  });


		  hostJoin.addEventListener('mouseup', function(){
		  	if (!hasHost) {
			  	sync.instance.child('host').set(user);
		  	} else if (hasHost && (isHost || isMod)) {
		  		sync.instance.child('host').set(null);
		  	}
		  });

		  var joined = 0;
		  for (var i = 0; i < 5; i++) {
		  	document.querySelectorAll('.joinButton')[i].addEventListener('mouseup', function(e){
			  	var i = parseInt(e.target.id.slice(1,2));
			  	console.log(i);
			  	if (!players[i - 1].joined && joined == 0) {
			  		console.log('not joined');
			  		//joined = i;
			  		sync.instance.child('players').child(i - 1).set({displayName: user.displayName, id: user.userId, joined: true, score: 0});
			  	} else if (joined == i || isMod) {
			  		//joined = 0;
			  		sync.instance.child('players').child(i - 1).set({joined: false});
			  	}
			  });
		  }
		  
			}
	  });
  });

	function getAverage(arr) {
		var sum = 0;
		for (var i = 0; i < arr.length; i++) {
			sum += arr[i];
		}
		return sum / (arr.length);
	}

	function sortByKey(array, key) {
    return array.sort(function(a, b) {
      var x = a[key]; var y = b[key];
      return ((x < y) ? -1 : ((x > y) ? 1 : 0));
    });
	}

	function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
    return array;
  }

  function decode(data) {
  	for (var i = 0; i < data.results.length; i++) {
  		data.results[i].category = decodeURIComponent(data.results[i].category);
  		data.results[i].difficulty = decodeURIComponent(data.results[i].difficulty);
  		data.results[i].question = decodeURIComponent(data.results[i].question);
  		data.results[i].correct_answer = decodeURIComponent(data.results[i].correct_answer);
  		for (var x = 0; x < 3; x++) {
				data.results[i].incorrect_answers[x] = decodeURIComponent(data.results[i].incorrect_answers[x]);
  		}
  	}
  	return data;
  }

</script>		
</body>
</html>